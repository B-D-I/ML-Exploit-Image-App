import os
import datetime
from classification import *
from mitigations import sanity_check, integrity_check
from flask import Flask, render_template, request, render_template_string, abort
from werkzeug.utils import secure_filename


app = Flask(__name__, template_folder='templates')
app.config['UPLOAD_EXTENSIONS'] = ['.jpg', '.jpeg', '.png']
app.config['UPLOAD_PATH'] = 'static/images/'


@app.errorhandler(500)
def page_error(e):
    print(e)
    return render_template('500.html'), 500


@app.route('/', methods=['GET'])
def hello_world():
    return render_template('index.html')


@app.route('/', methods=['POST'])
def predict():
    try:
        # if sanity_check() and integrity_check(model_path):
        image_file = request.files['image_file']
        # sanitise image with secure_filename function -> remove paths and special chars
        filename = secure_filename(image_file.filename)
        predict_image_path = "static/images/" + filename
        if image_file != '':
            # confirm correct file extension
            file_ext = os.path.splitext(filename)[1]
            if file_ext not in app.config['UPLOAD_EXTENSIONS']:
                abort(400)
            image_file.save(os.path.join(app.config['UPLOAD_PATH'], filename))
            # predict using image
            img = set_image(predict_image_path)
            scene = prediction(img)
            landing = safe_landing(scene)

            return render_template('index.html', prediction=scene, safe_landing=landing, image=predict_image_path)
        # else:
        #     page_error()
    except Exception as ex:
        page_error(ex)


# Contact page is where the server side template injection vulnerability is found. Inject payload into template!
# To mitigate, use render_template()
@app.route('/contact')
def index():
    date = request.args.get('date') or datetime.datetime.now().date()
    template = f'''
    <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Contact</title>
</head>
<body>

<h1>Date: {date}</h1><br />
<h4>For queries please contact nathan at: vulnerable@email.com</h4>

</body>
</html>
    '''
    return render_template_string(template)

# secure method for routing contacts page:
# @app.route('/contact', methods=['GET'])
# def contact():
#     return render_template('contact.html', dt=datetime.datetime.now().date())


if __name__ == '__main__':
    app.run()
